name: justfocus
version: '2.0.0'
summary: A distraction-free focus timer.
description: |
  A distraction-free focus timer
grade: stable
confinement: strict
base: core24
icon: snap/gui/icon.png
title: JustFocus
website: https://andre-i.eu
issues: https://github.com/goto-eof
license: Creative Commons Attribution-NonCommercial
compression: xz
apps:
  justfocus:
    command: executor
    extensions: [ gnome ]
    plugs:
      - desktop
      - wayland
platforms:
  amd64:
    build-on: [ amd64 ]
    build-for: [ amd64 ]
  arm64:
    build-on: [ arm64 ]
    build-for: [ arm64 ]
parts:
  wrapper:
    plugin: dump
    source: snap/local
    source-type: local
  application:
    plugin: maven
    source: .
    build-packages:
      - openjdk-21-jdk
      - maven
    override-build: |
      getproxy() {
          local proxy_url="$1"
          local proto=$(echo "$proxy_url" | sed -E 's/^(http|https):\/\///; s/:.*//')
          local user_pass=$(echo "$proxy_url" | sed -E 's/^(http|https):\/\///; s/@.*//; s/:/ /' | grep " ")
          local host_port=$(echo "$proxy_url" | sed -E 's/^(http|https):\/\///; s/.*@//' | grep ":")
      
          if [ -n "$user_pass" ]; then
              user=$(echo "$user_pass" | cut -d' ' -f1)
              pass=$(echo "$user_pass" | cut -d' ' -f2)
          fi
      
          if [ -n "$host_port" ]; then
              host=$(echo "$host_port" | cut -d':' -f1)
              port=$(echo "$host_port" | cut -d':' -f2)
          else
              host=$(echo "$proxy_url" | sed -E 's/^(http|https):\/\///')
              port="" # Default port for http/https will be used if not specified
          fi
      }
      
      http=""
      https=""
      
      if [ -n "${http_proxy:-}" ]; then
          getproxy "$http_proxy"
          http="-Dhttp.proxyHost=$host -Dhttp.proxyPort=$port"
      fi
      
      if [ -n "${https_proxy:-}" ]; then
          getproxy "$https_proxy"
          https="-Dhttps.proxyHost=$host -Dhttps.proxyPort=$port"
      fi
      
      export MAVEN_OPTS="$http $https"
      
      mvn clean install -DskipTests
      
      JAVA_HOME="/usr/lib/jvm/java-21-openjdk-amd64"
      "$JAVA_HOME"/bin/jlink --module-path "$JAVA_HOME"/jmods \
                             --add-modules java.base,java.desktop \
                             --output custom-jre \
                             --compress=2 \
                             --no-header-files \
                             --no-man-pages
      
      mkdir -p "$SNAPCRAFT_PART_INSTALL"/jar
      
      cp target/just-focus.jar "$SNAPCRAFT_PART_INSTALL"/jar/just-focus.jar
      cp -r custom-jre "$SNAPCRAFT_PART_INSTALL"/
